function cgpApiInit(){document.querySelectorAll(".cgp-custom-api-results").forEach((t=>{cgpApiSetupResults(t)}))}function cgpApiSetupResults(t){let a=t.getAttribute("id"),e=t.getAttribute("data-lang"),i=t.querySelector(".sc-cgp-api-ft-data"),l=t.getAttribute("data-api-url"),r=t.getAttribute("data-app-url"),s=t.getAttribute("data-result-url"),n=t.getAttribute("data-search-url"),d=t.getAttribute("data-type"),o=t.getAttribute("data-theme"),c=`Most accessed ${d} data`,p="Most accessed foundation data",u="Données de base les plus consultées",g="Données de base les plus consultées",f="View all data",m="Afficher tout",h="View all data",b="Afficher tout";null!==o&&(c=`Most accessed ${o} data`,p=`Most accessed ${o} foundation data`,u="Données de base les plus consultées",g="Données de base les plus consultées",h=`View all ${o} data`,b="Afficher tout"),"featured"===d&&(null!==o?(f=`View all ${o} data`,m="Afficher tout"):(f=`View all ${d} data`,m="Afficher tout")),"foundational"===d&&(f="View all foundation data",m="Afficher tout"),cgpApiGetData({itemid:a,lang:e,htmlwrap:i,apiurl:l,appurl:r,resulturl:s,searchurl:n,datatype:d,theme:o,layout:t.getAttribute("data-layout"),showpagination:parseInt(t.getAttribute("data-show-pagination")),numitemsperpage:parseInt(t.getAttribute("data-num-items-page")),maxitems:parseInt(t.getAttribute("data-max-items"))},{en:{leafletAtrribution:"© Her Majesty the Queen in Right of Canada, as represented by the Minister of Natural Resources",na:"N/A",nodata:"We're sorry, something went wrong, please refresh the page.",org:"Organization: ",pub:"Published: ",sectiontitleft:c,sectiontitlefnd:p,showless:"Show Less",view:"View Record",viewalldata:f,viewallftdata:h,viewfnddata:"View foundation data",viewftdata:"View featured data",viewmore:"View More",tabListLabel:"Related topics"},fr:{leafletAtrribution:"© Sa Majesté la Reine du Chef du Canada, représentée par le ministre des Ressources naturelles",na:"N/A",nodata:"Nous sommes désolés, quelque chose s'est mal passé. Veuillez rafraîchir la page",org:"Organisation : ",pub:"Publié : ",sectiontitleft:u,sectiontitlefnd:g,showless:"Montrer moins",view:"Afficher l'enregistrement",viewalldata:m,viewallftdata:b,viewfnddata:"Ensembles de données de base",viewftdata:"Jeux de données en vedette",viewmore:"Voir plus",tabListLabel:"Sujets connexes"}})}function cgpApiGetData(t,a){fetch(t.apiurl).then((function(t){return t.json()})).then((function(e){let i=e.Items.slice(0,t.maxitems);cgpApiShowData(t,a,i)})).then((function(e){cgpApiMakeLeafletMap(t,a)})).catch((function(e){cgpApiGetDataError(t,a),console.warn(a[t.lang].nodata,e)}))}function cgpApiShowData(t,a,e){let i,l="",r="",s="",n="",d="",o="",c="",p="",u=1,g="",f=1,m="featured"===t.datatype?a[t.lang].sectiontitleft:a[t.lang].sectiontitlefnd,h=("featured"===t.datatype?a[t.lang].viewfnddata:a[t.lang].viewftdata,""),b="";if("featured"===t.datatype&&(h=null!==t.theme?`${t.appurl}?theme=${t.theme}&lang=${t.lang}`:`${t.appurl}?lang=${t.lang}`),"foundational"===t.datatype&&(h=null!==t.theme?`${t.appurl}?foundational=y&theme=${t.theme}&lang=${t.lang}`:`${t.appurl}?foundational=y&lang=${t.lang}`),b=null!==t.theme?`${t.appurl}?theme=${t.theme}&lang=${t.lang}`:`${t.appurl}?lang=${t.lang}`,"full"===t.layout){l+='<div class="sec-header">',l+=`<h2 class="header-title">${m}</h2>`,l+="</div>",l+='<div class="sec-results-nav">',l+='<ul class="list">',l+=`<li class="list-item"><a href="${h}" target="_blank">${a[t.lang].viewalldata} <i class="fas fa-caret-right" aria-hidden="true"></i></a></li>`,l+="</ul>",l+="</div>",l+='<div class="sec-results-content" aria-live="polite">',e.forEach((e=>{if(s=e.title,n=e.id,d=e.organisation,o=e.coordinates,c=e.keywords,p=c.split(", "),i=e.published,resUrl=`${t.resulturl}?id=${n}&lang=${t.lang}`,resDesc=e.description,resDescExcerpt=resDesc.replace(/^(.{240}[^\s]*).*/,"$1"),resDesc.length>240&&(resDescExcerpt+=" ..."),g="card data-card show",mapCSSID=`cgp-api-map-${t.datatype}-${f}`,1===t.showpagination&&f>t.numitemsperpage&&(g="card data-card hide"),l+=`<div class="${g}" data-page-group="${u}">`,l+='<div class="card-body">',l+='<div class="card-map-wrap">',l+=`<div class="card-leaflet-map-wrap"><div id="${mapCSSID}" data-map-id="${n}" data-map-coords="${o}" class="card-leaflet-map"></div></div>`,l+="</div>",l+='<div class="card-content-wrap">',l+=`<h3 class="card-title"><a href="${resUrl}" target="_blank">${s}</a></h3>`,p=p.filter((t=>t)),p=cgpRemoveArrayVals(p,"null"),p.length>0){l+=`<div class="card-keywords ${t.datatype}">`,l+=`<h4 class="card-keywords-heading cgp-inv">${a[t.lang].tabListLabel}</h4>`,l+='<ul class="list">';let e=1;for(keyword of p){let a=`${t.searchurl}?keyword=${encodeURIComponent(keyword.toLowerCase())}&lang=${t.lang}`;l+=e<=5?`<li class="list-item"><a href="${a}" target="_blank">${keyword}</a></li>`:`<li class="list-item hidden"><a href="${a}" target="_blank">${keyword}</a></li>`,e++}p.length>5&&(l+=`<li class="list-item"><button class="show-more">${a[t.lang].viewmore}</button></li>`),l+="</ul>",l+="</div>"}l+='<div class="card-meta">',l+=`<p class="card-meta-item card-meta-item-org"><strong>${a[t.lang].org}</strong>${d}</p>`,l+=`<p class="card-meta-item card-meta-item-pub-date"><strong>${a[t.lang].pub}</strong>${i}</p>`,l+="</div>",l+='<div class="card-text">',l+=`<p>${resDescExcerpt}</p>`,l+="</div>",l+='<div class="card-button">',l+=`<p><a href="${resUrl}" target="_blank" class="btn btn-sm" aria-label="${s}">${a[t.lang].view}<i class="fas fa-long-arrow-alt-right"></i></a></p>`,l+="</div>",l+="</div>",l+="</div>",l+="</div>",f%t.numitemsperpage==0&&u++,f++})),l+="</div>";let b=0;if(e.length>t.numitemsperpage&&(b=Math.floor(e.length/t.numitemsperpage)),b>1&&1===t.showpagination){let t=1;for(r+='<div class="sec-pagination">',r+=`<nav class="pagination-nav" aria-label="Pagination Navigation" data-current-page-group="page-group-${t}">`,r+='<ul class="pagination-list">';t<=b;)r+=1==t?`<li class="pagination-list-item"><button class="pagination-btn current" data-page-num="${t}" aria-label="Current Page - Page ${t}" aria-current="true" aria-disabled="true">${t}</button></li>`:`<li class="pagination-list-item"><button class="pagination-btn" data-page-num="${t}" aria-label="Goto Page ${t}" aria-current="false">${t}</button></li>`,t++;r+="</ul>",r+="</nav>",r+="</div>"}t.htmlwrap.innerHTML=l+r,paginationEl=t.htmlwrap.querySelector(".sec-pagination"),b>1&&1===t.showpagination&&cgpApiMakePagination(paginationEl),cgpApiToggleKeywords(a,t)}else"compact"===t.layout&&(l+='<div class="sec-results-content" aria-live="polite">',e.forEach((a=>{s=a.title,n=a.id,o=a.coordinates,resUrl=`${t.resulturl}?id=${n}&lang=${t.lang}`,g="card data-card",mapCSSID=`cgp-api-map-${t.datatype}-${f}`,l+=`<div class="${g}">`,l+='<div class="card-body">',l+='<div class="card-map-wrap">',l+='<div class="card-leaflet-map-wrap">',l+=`<div id="${mapCSSID}" data-map-id="${n}" data-map-coords="${o}" class="card-leaflet-map"></div>`,l+="</div>",l+="</div>",l+='<div class="card-content-wrap">',l+=`<h3 class="card-title"><a href="${resUrl}" target="_blank">${s}</a></h3>`,l+="</div>",l+="</div>",l+="</div>",f++})),l+="</div>",t.htmlwrap.innerHTML=l)}function cgpApiMakeLeafletMap(t,a){document.querySelectorAll(".card-leaflet-map").forEach((e=>{let i=e.getAttribute("id"),l=e.getAttribute("data-map-coords"),r=JSON.parse(l),s=[(r[0][2][1]+r[0][0][1])/2,(r[0][1][0]+r[0][0][0])/2],n=0,d=Math.max(Math.abs(r[0][2][1]-r[0][0][1]),Math.abs(r[0][1][0]-r[0][0][0]));if("compact"!==t.layout){let t=40.7436654315252*d*11132/15;n=Math.max(Math.log2(36e5/t),1)}if(i.includes(t.datatype)){var o=L.map(i).setView(s,n);L.tileLayer("https://geoappext.nrcan.gc.ca/arcgis/rest/services/BaseMaps/CBMT_CBCT_GEOM_3857/MapServer/WMTS/tile/1.0.0/BaseMaps_CBMT_CBCT_GEOM_3857/default/default028mm/{z}/{y}/{x}.jpg",{attribution:a[t.lang].leafletAtrribution}).addTo(o);var c=[{type:"Feature",properties:{id:i,tag:"geoViewGeoJSON"},geometry:{type:"Polygon",coordinates:r}}];L.geoJSON(c).addTo(o)}}))}function cgpApiMakePagination(t){t.addEventListener("click",(function(a){if(a.target.hasAttribute("data-page-num")){a.preventDefault();let e=a.target.getAttribute("data-page-num"),i=t.closest(".sc-cgp-api-ft-data").querySelectorAll(".card"),l=t.querySelectorAll(".pagination-btn");for(btn of l)label=btn.getAttribute("aria-label"),btn.setAttribute("aria-label",label.replace("Current Page - ","")),btn.setAttribute("aria-disabled",!1),btn.setAttribute("aria-current",!1),btn.classList.remove("current");a.target.setAttribute("aria-label","Current Page - Page "+e),a.target.setAttribute("aria-current",!0),a.target.setAttribute("aria-disabled",!0),a.target.classList.add("current");for(let t of i){let a=t.getAttribute("data-page-group");t.classList.remove("show"),t.classList.add("hide"),e==a&&(t.classList.remove("hide"),t.classList.add("show"))}}}))}function cgpApiGetDataError(t,a){let e="";e+='<div class="sc-cgp-api-ft-data-results sc-cgp-api-error">',e+=`<p>${a[t.lang].nodata}</p>`,e+="</div>",t.htmlwrap.innerHTML=e}function cgpApiToggleKeywords(t,a){var e=document.querySelectorAll(`.card-keywords.${a.datatype} .show-more`);for(const i of e)i.addEventListener("click",(function(e){console.log(i),i.textContent=i.firstChild.textContent===t[a.lang].viewmore?t[a.lang].showless:t[a.lang].viewmore;let l=i.parentElement.parentElement.querySelectorAll(".list-item");for(let t of l)t.classList.contains("hidden")?(t.classList.add("show"),t.classList.remove("hidden")):t.classList.contains("show")&&(t.classList.add("hidden"),t.classList.remove("show"))}))}function cgpApiUpdateResults(t,a,e){let i="",l=t.getAttribute("data-parent-id"),r=document.getElementById(l),s=r.getAttribute("data-loader-gif"),n="featured"===r.getAttribute("data-type")?"foundational":"featured",d=r.getAttribute("data-api-url"),o="featured"===r.getAttribute("data-type")?d.replace("featured","foundational"):d.replace("foundational","featured");r.setAttribute("data-type",n),r.setAttribute("data-api-url",o),i+='<div class="content-loader">',i+=`<img src="${s}" alt="Content loading" />`,i+="</div>",r.querySelector(".sc-cgp-api-ft-data").innerHTML=i,cgpApiSetupResults(r)}function cgpApiCapitalizeStr(t){return"string"!=typeof t?"":t.charAt(0).toUpperCase()+t.slice(1)}function cgpRemoveArrayVals(t){for(var a,e,i=arguments,l=i.length;l>1&&t.length;)for(a=i[--l];-1!==(e=t.indexOf(a));)t.splice(e,1);return t}cgpApiInit();
